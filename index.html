<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة علي عصام التعليمية</title>
    <!-- استدعاء المكتبات عبر روابط CDN موثوقة ومدعومة عالمياً -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.321.0/dist/umd/lucide.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #0b0f1a;
            --card: #161b2a;
            --text: #ffffff;
            --text-dim: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        .app-shell { width: 100%; max-width: 500px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; border-left: 1px solid var(--border); border-right: 1px solid var(--border); position: relative; }
        
        /* شريط الحالة العلوي */
        .status-header { padding: 12px; font-size: 12px; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; gap: 10px; border-bottom: 1px solid var(--border); }
        .indicator { width: 8px; height: 8px; border-radius: 50%; background: #475569; }
        .indicator.active { background: #10b981; box-shadow: 0 0 10px #10b981; }

        /* شاشة التحميل */
        #splash { position: absolute; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* الشاشات */
        .view { display: none; padding: 25px; flex: 1; overflow-y: auto; flex-direction: column; }
        .view.active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* نماذج الإدخال */
        h1 { font-size: 26px; margin-bottom: 20px; text-align: right; }
        .input-box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; color: #fff; width: 100%; margin-bottom: 15px; font-size: 16px; outline: none; text-align: right; }
        .btn { border-radius: 12px; padding: 16px; font-weight: bold; border: none; cursor: pointer; width: 100%; font-size: 16px; transition: 0.3s; margin-top: 10px; }
        .btn-main { background: var(--primary); color: white; }
        .btn-sub { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }

        /* البطاقات */
        .item-card { background: var(--card); border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .item-info { text-align: right; }
        .item-info b { display: block; font-size: 16px; }
        .item-info span { color: var(--text-dim); font-size: 12px; }

        /* التنقل */
        .bottom-nav { position: absolute; bottom: 20px; left: 15px; right: 15px; background: rgba(22, 27, 42, 0.95); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 20px; display: none; padding: 12px; justify-content: space-around; }
        .nav-tab { color: var(--text-dim); text-align: center; font-size: 11px; flex: 1; cursor: pointer; }
        .nav-tab.active { color: var(--primary); }
    </style>
</head>
<body>

<div id="splash">
    <div class="loader"></div>
    <p style="margin-top:20px; color:var(--text-dim)">جاري الاتصال بسحابة علي عصام...</p>
</div>

<div class="app-shell">
    <div class="status-header">
        <div id="cloud-status" class="indicator"></div>
        <span id="cloud-label">فحص الاتصال...</span>
    </div>

    <!-- Login -->
    <div id="v-login" class="view">
        <h1>تسجيل الدخول</h1>
        <input type="text" id="l-u" class="input-box" placeholder="اسم المستخدم">
        <input type="password" id="l-p" class="input-box" placeholder="كلمة المرور">
        <button class="btn btn-main" onclick="portal.login()">دخول</button>
        <button class="btn btn-sub" onclick="portal.go('v-reg')">إنشاء حساب جديد</button>
    </div>

    <!-- Register -->
    <div id="v-reg" class="view">
        <h1>حساب جديد</h1>
        <input type="text" id="r-u" class="input-box" placeholder="اختر اسم مستخدم">
        <input type="password" id="r-p" class="input-box" placeholder="كلمة المرور">
        <select id="r-b" class="input-box">
            <option value="sci">علمي</option>
            <option value="lit">أدبي</option>
        </select>
        <button class="btn btn-main" onclick="portal.register()">تأكيد الحساب</button>
        <button class="btn btn-sub" onclick="portal.go('v-login')">لديك حساب؟ ادخل هنا</button>
    </div>

    <!-- Dashboard -->
    <div id="v-main" class="view">
        <h1 id="user-title">مرحباً بك</h1>
        <div id="items-list" style="padding-bottom:100px"></div>
        <button style="position:fixed; bottom:100px; left:30px; width:60px; height:60px; border-radius:50%; background:var(--primary); color:white; border:none; font-size:24px; box-shadow:0 10px 20px rgba(0,0,0,0.4)" onclick="portal.addItem()">+</button>
    </div>

    <!-- Nav -->
    <nav id="nav" class="bottom-nav">
        <div class="nav-tab active" onclick="portal.go('v-main')"><i data-lucide="home"></i><br>الرئيسية</div>
        <div class="nav-tab" onclick="portal.logout()"><i data-lucide="log-out"></i><br>خروج</div>
    </nav>
</div>

<script type="module">
    // استيراد Firebase بطريقة متوافقة مع جميع أنواع الاستضافة
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    let db, auth, user = null, data = null;
    const APP_PATH = "ali_essam_v5_pro";

    const portal = {
        async init() {
            try {
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // تفعيل التخزين المحلي لضمان العمل حتى عند حظر الشبكة
                try { await enableIndexedDbPersistence(db); } catch(e){}

                await signInAnonymously(auth);
                document.getElementById('cloud-status').classList.add('active');
                document.getElementById('cloud-label').innerText = "متصل سحابياً ✓";
            } catch (e) {
                document.getElementById('cloud-label').innerText = "وضع الأوفلاين";
            }

            const sid = localStorage.getItem("SID");
            if (sid) {
                user = sid;
                await this.pull();
                if(data) this.go('v-main');
            }

            document.getElementById('splash').style.display = 'none';
            if(window.lucide) lucide.createIcons();
        },

        go(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('nav').style.display = (id === 'v-main') ? 'flex' : 'none';
        },

        async register() {
            const u = document.getElementById('r-u').value.trim();
            const p = document.getElementById('r-p').value;
            const b = document.getElementById('r-b').value;
            if(!u || !p) return alert("أكمل البيانات");

            const ref = doc(db, 'artifacts', APP_PATH, 'public', 'data', 'users', u);
            const snap = await getDoc(ref);
            if(snap.exists()) return alert("الاسم مستخدم");

            const obj = { p: btoa(p), b, list: [] };
            await setDoc(ref, obj);
            localStorage.setItem("SID", u);
            user = u; data = obj;
            this.go('v-main');
            this.render();
        },

        async login() {
            const u = document.getElementById('l-u').value.trim();
            const p = document.getElementById('l-p').value;
            const ref = doc(db, 'artifacts', APP_PATH, 'public', 'data', 'users', u);
            const snap = await getDoc(ref);
            
            if(snap.exists() && atob(snap.data().p) === p) {
                user = u; data = snap.data();
                localStorage.setItem("SID", u);
                this.go('v-main');
                this.render();
            } else {
                alert("بيانات خاطئة");
            }
        },

        async pull() {
            try {
                const snap = await getDoc(doc(db, 'artifacts', APP_PATH, 'public', 'data', 'users', user));
                if(snap.exists()) {
                    data = snap.data();
                    this.render();
                }
            } catch(e){}
        },

        async addItem() {
            const title = prompt("اسم المادة أو الملاحظة؟");
            if(title) {
                data.list.push({ t: title, d: new Date().toLocaleDateString() });
                this.render();
                await setDoc(doc(db, 'artifacts', APP_PATH, 'public', 'data', 'users', user), data);
            }
        },

        render() {
            document.getElementById('user-title').innerText = `أهلاً ${user}`;
            const list = document.getElementById('items-list');
            list.innerHTML = data.list.map((it, i) => `
                <div class="item-card">
                    <div class="item-info"><b>${it.t}</b><span>${it.d}</span></div>
                    <i data-lucide="trash-2" style="color:#ef4444; cursor:pointer" onclick="portal.del(${i})"></i>
                </div>
            `).join('') || '<p style="text-align:center; opacity:0.3; margin-top:50px">قائمتك فارغة</p>';
            lucide.createIcons();
        },

        async del(i) {
            data.list.splice(i, 1);
            this.render();
            await setDoc(doc(db, 'artifacts', APP_PATH, 'public', 'data', 'users', user), data);
        },

        logout() {
            localStorage.removeItem("SID");
            location.reload();
        }
    };

    window.portal = portal;
    window.onload = () => portal.init();
</script>
</body>
</html>

